<main class="main">
    <div class="header-container">
        <div class="header-top">
            <button
                mat-icon-button
                [matMenuTriggerFor]="appMenu"
                class="menu-button"
            >
                <mat-icon>menu</mat-icon>
            </button>
            <mat-menu #appMenu="matMenu">
                <button mat-menu-item (click)="navigateToFeedback()">
                    <mat-icon>feedback</mat-icon>
                    <span>Ge feedback</span>
                </button>
                @if (authService.isAuthenticated()) {
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="navigateToAdminFeedback()">
                    <mat-icon>admin_panel_settings</mat-icon>
                    <span>Ny feedback</span>
                    @if (unhandledFeedbackCount > 0) {
                    <span class="feedback-badge">{{
                        unhandledFeedbackCount
                    }}</span>
                    }
                </button>
                <button mat-menu-item (click)="navigateToAdminSuggestions()">
                    <mat-icon>rate_review</mat-icon>
                    <span>Förslag på nya laddstationer</span>
                    @if (unhandledSuggestionsCount > 0) {
                    <span class="feedback-badge">{{
                        unhandledSuggestionsCount
                    }}</span>
                    }
                </button>
                }
            </mat-menu>

            <h1>{{ title }}</h1>
            <button
                mat-icon-button
                (click)="themeService.toggleDarkMode()"
                class="theme-button"
                [title]="themeService.isDarkMode() ? 'Ljus läge' : 'Mörkt läge'"
            >
                <mat-icon>{{
                    themeService.isDarkMode() ? "light_mode" : "dark_mode"
                }}</mat-icon>
            </button>
            <button
                mat-icon-button
                [matMenuTriggerFor]="userMenu"
                class="user-menu-button"
            >
                @if (authService.isAuthenticated()) {
                <mat-icon class="auth-icon">account_circle</mat-icon>
                } @else {
                <mat-icon>account_circle</mat-icon>
                }
            </button>
            <mat-menu #userMenu="matMenu">
                @if (authService.isAuthenticated()) {
                <button
                    mat-menu-item
                    (click)="navigateToProfile()"
                    class="menu-header-button"
                >
                    <mat-icon>person</mat-icon>
                    <span>{{ authService.currentUser() }}</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="navigateToChangePassword()">
                    <mat-icon>lock</mat-icon>
                    <span>Ändra lösenord</span>
                </button>
                @if (authService.isSuperAdmin()) {
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="navigateToUserList()">
                    <mat-icon>manage_accounts</mat-icon>
                    <span>Hantera användare</span>
                </button>
                <button mat-menu-item (click)="exportChargingPoints()">
                    <mat-icon>backup</mat-icon>
                    <span>Exportera backup</span>
                </button>
                }
                <button mat-menu-item (click)="logout()">
                    <mat-icon>logout</mat-icon>
                    <span>Logga ut</span>
                </button>
                } @else {
                <button mat-menu-item (click)="navigateToLogin()">
                    <mat-icon>login</mat-icon>
                    <span>Logga in</span>
                </button>
                }
            </mat-menu>
        </div>
        <h5>Anpassade, eller lämpliga, när man har husvagn</h5>

        <mat-button-toggle-group [(value)]="viewMode" aria-label="View Mode">
            <mat-button-toggle value="map">Karta</mat-button-toggle>
            <mat-button-toggle value="list">Lista</mat-button-toggle>
        </mat-button-toggle-group>

        @if (viewMode === 'list') {
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Sök</mat-label>
            <input
                matInput
                [(ngModel)]="searchText"
                placeholder="Sök på stad, plats..."
            />
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        }
    </div>

    <!-- Offline Banner -->
    @if (!isOnline) {
    <div class="offline-banner">
        <mat-icon>cloud_off</mat-icon>
        <span>Du är offline. Vissa funktioner kan vara begränsade.</span>
    </div>
    }

    <!-- Loading Spinner -->
    @if (isLoading) {
    <div class="loading-container">
        <mat-icon class="spinning">refresh</mat-icon>
        <p>Laddar laddstationer...</p>
    </div>
    }

    <div class="content">
        @if (viewMode === 'list') {
        <div class="list-view">
            @for (item of filteredChargePoints; track item.id) {
            <div class="one-row-container">
                <div class="image-container">
                    @if (item.hasImage) {
                    <img
                        [src]="getImageUrl(item.id)"
                        alt="{{ item.title }}"
                        loading="lazy"
                    />
                    } @else {
                    <div class="placeholder-image">
                        <mat-icon>ev_station</mat-icon>
                    </div>
                    }
                </div>
                <div class="text-content-container">
                    <span class="left-side-content">{{ item.title }}</span>
                    <span class="right-side-content">{{ item.city }}</span>
                </div>

                <div class="actions">
                    @if (authService.isAuthenticated()) {
                    <button
                        class="link-button"
                        mat-mini-fab
                        matTooltip="Redigera"
                        color="accent"
                        (click)="navigateToEdit(item)"
                    >
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button
                        class="link-button"
                        mat-mini-fab
                        matTooltip="Ta bort"
                        color="warn"
                        (click)="deleteChargePoint(item)"
                    >
                        <mat-icon>delete</mat-icon>
                    </button>
                    }
                    <button
                        class="link-button"
                        mat-mini-fab
                        matTooltip="Open the place in Google maps"
                        color="primary"
                    >
                        <a
                            [href]="
                                'https://www.google.com/maps/place/' +
                                item.mapCoordinates
                            "
                            target="_blank"
                            rel="noopener"
                        >
                            <mat-icon>map</mat-icon>
                        </a>
                    </button>
                </div>
            </div>
            } @empty {
            <p>Oh, snap! There are no charge points for the selected region!</p>
            }
        </div>
        } @if (viewMode === 'map') {
        <div class="map-view">
            <app-map
                [chargePoints]="filteredChargePoints"
                (editChargePoint)="navigateToEdit($event)"
                (deleteChargePoint)="deleteChargePoint($event)"
                (viewComments)="navigateToDetails($event)"
            ></app-map>
        </div>
        }
    </div>

    <button
        mat-fab
        color="primary"
        class="add-fab"
        [matTooltip]="
            authService.isAuthenticated()
                ? 'Lägg till laddstation'
                : 'Föreslå laddstation'
        "
        (click)="navigateToCreate()"
    >
        <mat-icon>add</mat-icon>
    </button>
</main>
