<h2 mat-dialog-title>{{ data ? 'Redigera' : 'Lägg till' }} laddstation</h2>
<mat-dialog-content>
  <form [formGroup]="form" class="edit-form">
    <mat-form-field appearance="outline">
      <mat-label>Titel</mat-label>
      <input matInput formControlName="title" required>
    </mat-form-field>

    <div class="row">
      <mat-form-field appearance="outline">
        <mat-label>Adress 1</mat-label>
        <input matInput formControlName="address1" required>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Adress 2</mat-label>
        <input matInput formControlName="address2">
      </mat-form-field>
    </div>

    <div class="row">
      <mat-form-field appearance="outline">
        <mat-label>Postnummer</mat-label>
        <input matInput formControlName="postalCode" required>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Stad</mat-label>
        <input matInput formControlName="city" required>
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline">
      <mat-label>Land</mat-label>
      <input matInput formControlName="country" required>
    </mat-form-field>

    <div class="map-container">
      <div id="edit-map"></div>
      <p class="help-text">Klicka på kartan eller dra markören för att ändra position.</p>
    </div>

    <div class="row">
      <mat-form-field appearance="outline">
        <mat-label>Koordinater (lat, lng)</mat-label>
        <input matInput formControlName="mapCoordinates" required>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Kapacitet (kW)</mat-label>
        <input matInput type="number" formControlName="capacity" required>
        @if (form.get('capacity')?.hasError('notInteger')) {
          <mat-error>
            Kapacitet måste vara ett heltal
          </mat-error>
        }
        @if (form.get('capacity')?.hasError('required')) {
          <mat-error>
            Kapacitet krävs
          </mat-error>
        }
      </mat-form-field>
    </div>

      <mat-form-field appearance="outline">
      <mat-label>Antal laddpunkter</mat-label>
      <input matInput type="number" formControlName="numberOfChargePoints">
      @if (form.get('numberOfChargePoints')?.hasError('notInteger')) {
        <mat-error>
          Antal laddpunkter måste vara ett heltal
        </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Kommentarer</mat-label>
      <textarea matInput formControlName="comments" rows="3"></textarea>
    </mat-form-field>

    <div class="image-section">
      <h3>Bild</h3>

      @if (data?.id && hasImage && !imagePreview) {
        <div class="current-image">
          <img [src]="getImageUrl()" alt="Laddstation" />
          <button mat-icon-button color="warn" (click)="deleteImage()" matTooltip="Ta bort bild">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      }

      @if (imagePreview) {
        <div class="image-preview">
          <img [src]="imagePreview" alt="Förhandsvisning" />
          <div class="preview-actions">
            <button mat-button (click)="cancelImageSelection()">Ta bort val</button>
            @if (data?.id && !isSuggestion) {
              <button mat-raised-button color="primary" (click)="uploadImage()" [disabled]="isUploadingImage">
                @if (isUploadingImage) {
                  <span>
                    <mat-icon class="spinning">refresh</mat-icon>
                    Laddar upp...
                  </span>
                } @else {
                  <span>Ladda upp</span>
                }
              </button>
            }
          </div>
        </div>
      }

      @if (!imagePreview && (!hasImage || !data?.id)) {
        <div class="upload-section">
          <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none" />
          <button mat-raised-button (click)="fileInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            {{ hasImage ? 'Byt bild' : 'Lägg till bild' }}
          </button>
          <p class="help-text">JPG, PNG eller WebP. Max 5MB.</p>
        </div>
      }
    </div>
  </form>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Avbryt</button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="!form.valid">Spara</button>
</mat-dialog-actions>
