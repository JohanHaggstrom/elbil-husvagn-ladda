<div class="page-container">
    <mat-card class="card">
        <mat-card-header>
            <div class="header-content">
                <button mat-icon-button (click)="onCancel()" class="back-button">
                    <mat-icon>arrow_back</mat-icon>
                </button>
                <mat-card-title>Lägg till ny användare</mat-card-title>
            </div>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="form" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Användarnamn</mat-label>
                    <input
                        matInput
                        formControlName="username"
                    />
                    @if (form.get('username')?.invalid && form.get('username')?.touched)
                    {
                    <mat-error>{{ usernameError }}</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Email</mat-label>
                    <input
                        matInput
                        type="email"
                        formControlName="email"
                    />
                    @if (form.get('email')?.invalid && form.get('email')?.touched) {
                    <mat-error>{{ emailError }}</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Roll</mat-label>
                    <mat-select formControlName="role">
                        @for (role of roles; track role) {
                        <mat-option [value]="role">{{ role }}</mat-option>
                        }
                    </mat-select>
                    @if (form.get('role')?.invalid && form.get('role')?.touched) {
                    <mat-error>Roll är obligatorisk</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Lösenord</mat-label>
                    <input
                        matInput
                        [type]="hidePassword ? 'password' : 'text'"
                        formControlName="password"
                    />
                    <button
                        type="button"
                        mat-icon-button
                        matSuffix
                        (click)="togglePasswordVisibility()"
                        [attr.aria-label]="'Hide password'"
                        [attr.aria-pressed]="hidePassword"
                    >
                        <mat-icon>{{
                            hidePassword ? "visibility_off" : "visibility"
                        }}</mat-icon>
                    </button>
                    @if (form.get('password')?.invalid && form.get('password')?.touched)
                    {
                    <mat-error>{{ passwordError }}</mat-error>
                    }
                </mat-form-field>

                <app-password-strength-indicator
                    [password]="form.get('password')?.value || ''"
                    (validityChange)="isPasswordValid = $event"
                ></app-password-strength-indicator>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Bekräfta lösenord</mat-label>
                    <input
                        matInput
                        [type]="hideConfirmPassword ? 'password' : 'text'"
                        formControlName="confirmPassword"
                    />
                    <button
                        type="button"
                        mat-icon-button
                        matSuffix
                        (click)="toggleConfirmPasswordVisibility()"
                        [attr.aria-label]="'Hide password'"
                        [attr.aria-pressed]="hideConfirmPassword"
                    >
                        <mat-icon>{{
                            hideConfirmPassword ? "visibility_off" : "visibility"
                        }}</mat-icon>
                    </button>
                    @if (form.get('confirmPassword')?.invalid &&
                    form.get('confirmPassword')?.touched) {
                    <mat-error>{{ confirmPasswordError }}</mat-error>
                    }
                </mat-form-field>

                <div class="actions">
                    <button
                        mat-raised-button
                        color="primary"
                        type="submit"
                        [disabled]="
                            isSubmitting ||
                            !isPasswordValid ||
                            form.invalid ||
                            form.get('password')?.value !== form.get('confirmPassword')?.value
                        "
                    >
                        @if (isSubmitting) {
                        <mat-spinner
                            diameter="20"
                            style="display: inline-block; margin-right: 8px"
                        ></mat-spinner>
                        Skapar... } @else { Skapa användare }
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>
</div>
